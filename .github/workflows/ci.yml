# .github/workflows/ci.yml
# Continuous Integration workflow for the Flujo project.
#
# Dependency Management:
# - Uses uv sync --all-extras to ensure all dependencies are installed
# - Includes prometheus-client and httpx for comprehensive testing
# - All dependencies are properly declared in pyproject.toml

name: Flujo CI

on:
  push:
    branches: [ "main" ]
  # Note: Pull requests are handled by pr-checks.yml for faster feedback

# Cancel any in-progress jobs for the same PR/branch when new commits are pushed.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ----------------------------------------------------------------------------
  # Job 1: Linting and Static Type Checking
  # ----------------------------------------------------------------------------
  lint-and-typecheck:
    name: Lint & Typecheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v1
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run Linter
        run: make lint

      - name: Run Type Checker
        run: make typecheck

  # ----------------------------------------------------------------------------
  # Job 2: Run Fast Tests (Parallel) - Quick Feedback
  # ----------------------------------------------------------------------------
  test-fast:
    name: Fast Tests (Parallel)
    runs-on: ubuntu-latest
    needs: lint-and-typecheck
    strategy:
      fail-fast: true
      matrix:
        python-version: ["3.11", "3.12"]
        mode: ["compat", "pure"]
    env:
      CI: "true"
      FLUJO_CLI_PERF_THRESHOLD: "0.2"
      FLUJO_CV_THRESHOLD: "1.0"
      FLUJO_CI_DB_SIZE: "250"  # Optimized database size for mass CI (was 500)
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Set up uv
        uses: astral-sh/setup-uv@v1
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Set dummy OpenAI API key for tests
        run: echo "OPENAI_API_KEY=dummy-key" >> $GITHUB_ENV

      - name: Set mode env
        run: |
          if [ "${{ matrix.mode }}" = "pure" ]; then echo "FLUJO_PURE_QUOTA=1" >> $GITHUB_ENV; fi

      - name: Run fast tests with coverage (${{ matrix.mode }})
        run: |
          # Run fast tests with limited parallelism for CI stability and speed
          uv run coverage run --source=flujo --parallel-mode -m pytest tests/ -m "not slow and not serial and not benchmark" -n 2

      - name: Store fast tests coverage file
        uses: actions/upload-artifact@v4
        with:
          name: coverage-fast-${{ matrix.python-version }}-${{ matrix.mode }}
          path: .coverage.*

      - name: Check for stray xdist flags
        run: |
          # Check for pytest -n usage outside allowed locations
          # Allowed: CI workflows, Makefile, Documentation
          # The pattern uses a variable to avoid self-matching
          PATTERN='pytest[^\n]*\s-+n'
          if git grep -nE "$PATTERN" -- ':!**/.github/workflows/*' ':!Makefile' ':!**/Makefile' ':!docs/**'; then
            echo 'pytest -n usage detected outside CI workflows and Makefile';
            exit 1;
          fi

  # ----------------------------------------------------------------------------
  # Job 3: Run Slow Tests (Serial) - Comprehensive Testing
  # ----------------------------------------------------------------------------
  test-slow:
    name: Slow Tests (Serial)
    runs-on: ubuntu-latest
    needs: lint-and-typecheck
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11"]  # Only run slow tests on one Python version
    env:
      CI: "true"
      FLUJO_CLI_PERF_THRESHOLD: "0.2"
      FLUJO_CV_THRESHOLD: "1.0"
      FLUJO_CI_DB_SIZE: "250"  # Optimized database size for mass CI (was 1000)
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Set up uv
        uses: astral-sh/setup-uv@v1
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Set dummy OpenAI API key for tests
        run: echo "OPENAI_API_KEY=dummy-key" >> $GITHUB_ENV

      - name: Run slow tests with coverage
        run: |
          # Run slow tests serially with coverage
          uv run coverage run --source=flujo --parallel-mode -m pytest tests/ -m "slow or serial or benchmark"

          # Run the comprehensive golden transcript tests
          uv run coverage run --source=flujo --append -m pytest tests/e2e/test_golden_transcript_*.py

      - name: Store slow tests coverage file
        uses: actions/upload-artifact@v4
        with:
          name: coverage-slow-${{ matrix.python-version }}
          path: .coverage.*

  # ----------------------------------------------------------------------------
  # Job 4: Run Full Test Suite (Legacy) - For Comprehensive Coverage
  # ----------------------------------------------------------------------------
  test-full:
    name: Full Test Suite
    runs-on: ubuntu-latest
    needs: lint-and-typecheck
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10"]  # Run full suite on older Python versions
    env:
      CI: "true"
      FLUJO_CLI_PERF_THRESHOLD: "0.2"
      FLUJO_CV_THRESHOLD: "1.0"
      FLUJO_CI_DB_SIZE: "250"  # Optimized database size for mass CI (was 500)
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Set up uv
        uses: astral-sh/setup-uv@v1
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Set dummy OpenAI API key for tests
        run: echo "OPENAI_API_KEY=dummy-key" >> $GITHUB_ENV

      - name: Run all tests with coverage
        run: |
          # Run non-SQLite tests with parallel mode for better performance
          uv run coverage run --source=flujo --parallel-mode -m pytest tests/ -k "not sqlite and not test_sqlite"

          # Run SQLite tests separately without parallel mode to avoid bus errors
          uv run coverage run --source=flujo --append -m pytest tests/ -k "sqlite or test_sqlite"

      - name: Store full test coverage file
        uses: actions/upload-artifact@v4
        with:
          name: coverage-full-${{ matrix.python-version }}
          path: .coverage.*

  # ----------------------------------------------------------------------------
  # Job 5: Combine and Report Code Coverage
  # ----------------------------------------------------------------------------
  coverage:
    name: Report Coverage
    runs-on: ubuntu-latest
    needs: [test-fast, test-slow, test-full]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Set up uv
        uses: astral-sh/setup-uv@v1
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Download coverage data
        uses: actions/download-artifact@v4
        with:
          path: .
          pattern: coverage-*
          merge-multiple: true

      - name: Combine coverage reports and check threshold
        run: |
          if ls .coverage.* 1> /dev/null 2>&1; then
            uv run coverage combine
            uv run coverage report --fail-under=90
            uv run coverage xml
            uv run coverage html
          else
            echo "No data to report."
          fi

      - name: Upload coverage report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-html
          path: htmlcov

  # ----------------------------------------------------------------------------
  # Job 6: Performance Analysis (Optional)
  # ----------------------------------------------------------------------------
  test-performance:
    name: Performance Analysis
    runs-on: ubuntu-latest
    needs: lint-and-typecheck
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11"]
    env:
      FLUJO_PERF_TARGET: tests/unit
      FLUJO_PERF_MARKERS: not slow and not serial and not benchmark
      FLUJO_PERF_TIMEOUT: "1200"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Set up uv
        uses: astral-sh/setup-uv@v1
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Set dummy OpenAI API key for tests
        run: echo "OPENAI_API_KEY=dummy-key" >> $GITHUB_ENV

      - name: Run performance analysis
        run: make test-perf

      - name: Upload performance report
        uses: actions/upload-artifact@v4
        with:
          name: performance-report
          path: test_performance_report.json

      - name: Upload raw performance log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-raw-log
          path: test_performance_raw.log

  # ----------------------------------------------------------------------------
  # Job 7: Ultra-Slow Tests (>30s, excluded from regular CI)
  # ----------------------------------------------------------------------------
  test-ultra-slow:
    name: Ultra-Slow Tests (>30s)
    runs-on: ubuntu-latest
    needs: lint-and-typecheck
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11"]
    env:
      CI: "true"
      FLUJO_CLI_PERF_THRESHOLD: "0.2"
      FLUJO_CV_THRESHOLD: "1.0"
      FLUJO_CI_DB_SIZE: "250"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Set up uv
        uses: astral-sh/setup-uv@v1
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Set dummy OpenAI API key for tests
        run: echo "OPENAI_API_KEY=dummy-key-for-testing" >> $GITHUB_ENV

      - name: Run ultra-slow tests
        run: |
          echo "⚠️ Running ultra-slow tests (>30s each)"
          echo "These tests are excluded from regular CI due to long execution time"
          make test-ultra-slow

  # ----------------------------------------------------------------------------
  # Job 8: Live API Tests (Optional but Recommended)
  # ----------------------------------------------------------------------------
  # This job is a placeholder for a critical testing practice.
  # To enable it, you would need to:
  # 1. Create live tests in a separate directory (e.g., tests/live/).
  # 2. Add API key secrets to your GitHub repository settings.
  # 3. Uncomment this job.
  # test-live:
  #   name: Live API Tests
  #   runs-on: ubuntu-latest
  #   if: github.event_name == 'push' && github.ref == 'refs/heads/main'
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: astral-sh/setup-uv@v1
  #     - name: Install dependencies
  #       run: uv sync --all-extras
  #     - name: Run live tests
  #       run: uv run pytest tests/live/
  #       env:
  #         OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  #         GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
  #         ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
