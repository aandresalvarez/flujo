name: Manual E2E Tests

on:
  workflow_dispatch:
    inputs:
      re_record_cassette:
        description: 'Re-record VCR cassette? (deletes old one)'
        required: true
        type: boolean
        default: false

jobs:
  run-e2e-tests:
    name: Run End-to-End Golden Transcript Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install hatch
          hatch run setup

      - name: Delete cassette if re-recording
        if: ${{ github.event.inputs.re_record_cassette == 'true' }}
        run: |
          echo "Re-recording enabled. Deleting old cassette."
          rm -f tests/e2e/cassettes/golden.yaml

      - name: Run E2E test against live API
        env:
          OPENAI_API_KEY: ${{ secrets.E2E_OPENAI_API_KEY }}
          CI_E2E_RUN: "true"
        run: |
          pytest tests/e2e/test_golden_transcript.py

      - name: Run comprehensive golden transcript tests
        env:
          OPENAI_API_KEY: ${{ secrets.E2E_OPENAI_API_KEY }}
          CI_E2E_RUN: "true"
        run: |
          pytest tests/e2e/test_golden_transcript_*.py

      - name: Upload new cassettes if recorded
        if: ${{ github.event.inputs.re_record_cassette == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: new-e2e-cassettes
          path: |
            tests/e2e/cassettes/golden.yaml
