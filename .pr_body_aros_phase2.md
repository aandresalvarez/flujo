## AROS Phase 2: Structured Outputs, AOP, Precheck, Health, Grammar Enforcement, Migration

This PR completes AROS Phase 2 across the framework: SOE improvements, AOP stages and extras, reasoning precheck refinements, health‑check analytics + export/filters, optional grammar enforcement, a migration tool, and comprehensive tests and docs.

### Highlights

- Structured Output Enforcement (SOE)
  - Wrapper‑based structured output hints for pydantic‑ai agents.
  - `grammar.applied` events include `schema_hash` (sha256 of JSON schema) for openai_json and outlines/xgrammar.
  - Provider-profile tests (no network): GPT‑5 (OpenAI Responses), GPT‑4o, GPT‑4o‑mini; `auto` emits grammar.applied.

- AOP (Adaptive Output Processing)
  - Stage 0: JSON region extraction + bounded unescape.
  - Stage 1: Tolerant decode tiers (json/json5/json‑repair).
  - Syntactic repair: DeterministicRepair integration.
  - SmartTypeCoercion: schema‑aware whitelisted conversions; anyOf/oneOf branch selection (with branch_choices recorded).
  - Extras packaging: `aop-extras` for `pyjson5` and `json-repair`.

- Reasoning Precheck
  - Skips validator when no plan markers found; emits `aros.reasoning.precheck.skipped`.
  - Forwards `max_tokens` to validator options when set.

- Health‑check CLI
  - Filters: `--step`, `--model` for targeted analysis.
  - Trend buckets: per-bucket `stages`, `step_stages`, `model_stages`.
  - Stage-aware and trend‑based recommendations (incl. stage‑specific rises).
  - JSON export metadata: `version`, `generated_at`. Supports stdout via `--output -`.

- Grammar Enforcement (experimental)
  - Opt‑in: `processing.enforce_grammar: true` for `outlines|xgrammar`.
  - Regex full‑match validation of the entire output string; emits `grammar.enforce.pass|fail|skipped`.
  - Safe fallbacks on non‑string outputs, missing schema, or compile errors.

- Migration Tool
  - `scripts/aros_migrate.py`: adds safe AROS defaults per step to pipeline YAMLs (non‑destructive merge). Supports dry‑run, backups, include/exclude filters.

### Files/Modules

- Policy / Enforcement:
  - `flujo/application/core/step_policies.py`: SOE schema_hash; grammar enforcement; precheck skip/max_tokens.
  - `flujo/domain/blueprint/loader.py`: `processing.enforce_grammar` accepted.

- AOP Processors:
  - `flujo/processors/aros.py`: Stage 0 extraction, tolerant decoder, SmartTypeCoercion (with anyOf/oneOf), syntactic repair integration.
  - `flujo/processors/__init__.py`: exports.
  - `flujo/utils/schema_utils.py`: derive JSON Schema from types (Pydantic v2 TypeAdapter).

- Grammar Adapters (stubs):
  - `flujo/grammars/adapters.py`: outlines/xgrammar regex/EBNF placeholders.

- Health‑check CLI:
  - `flujo/cli/main.py`: filters, trend buckets with stage breakdowns, stage/trend recommendations, export metadata and stdout.

- Docs / Spec:
  - `docs/guides/aros.md`: SOE/AOP/Precheck/Health; trend buckets; filters; stdout JSON; grammar enforcement; aop‑extras install.
  - `FSD.md`: progress updated; provider profiles; schema_hash; filters; export metadata; enforce_grammar flag; tests.

- Migration Script:
  - `scripts/aros_migrate.py`: add AROS processing defaults per step (merge‑only); backups; dry‑run.

### Tests

- SOE policy‑path: openai_json, auto→JSON, outlines, xgrammar; provider‑skip reasons; wrapper schema‑name propagation; wrapper kwargs response_format.
- AOP: Stage 0/1 behaviors; schema derivation; SmartCoercion success; anyOf branch choices recorded.
- Precheck: skipped when no plan; max_tokens forwarded to validator.
- Health‑check: JSON export bucket breakdowns; stage‑aware and trend‑based recs; edge cases (no runs, no since‑hours).
- Grammar enforcement: pass/fail on matching/non‑matching outputs.
- Integration: grammar.applied aggregated via TraceManager hook in a mock pipeline.

### QA

- Lint: `make lint` — passed.
- Type: `make typecheck` — passed.
- Pre-commit: ruff + ruff-format — passed.

### Migration Notes

Run the migration tool to add safe defaults (non‑destructive):

```bash
python scripts/aros_migrate.py '/path/to/projects' --dry-run
python scripts/aros_migrate.py '/path/to/projects'
```

Then incrementally enable:
- structured_output: openai_json + schema where supported
- aop: full + tolerant_level as needed (install aop‑extras)
- enforce_grammar: true (only after outputs are consistently schema‑shaped)

### Risks / Mitigations

- Grammar enforcement is off by default; opt‑in only.
- Tolerant decoders are extras; imports are guarded.
- Precheck changes are telemetry‑first and safe; no control‑flow exceptions are swallowed.

