version: '2.0'
name: test_hitl_loop_minimal

agents:
  counter_agent:
    model: "openai:gpt-4o-mini"
    system_prompt: |
      You are a simple counter. 
      - If count < 3: output {"action":"ask","question":"Question {{count}}?","count":{{count+1}}}
      - If count >= 3: output {"action":"finish","question":"Done! Press Enter.","count":{{count}}}
    output_schema:
      type: object
      properties:
        action: { type: string, enum: [ask, finish] }
        question: { type: string }
        count: { type: integer }
      required: [action, question, count]

steps:
  # Initialize counter
  - kind: step
    name: init
    uses: "skills.custom_tools:init_counter"
    updates_context: true

  # Simple loop with HITL
  - kind: loop
    name: test_loop
    loop:
      body:
        # Agent decides: ask or finish
        - kind: step
          name: agent_decides
          uses: agents.counter_agent
          input: |
            Current count: {{ context.count }}
            Decide: ask or finish?
          updates_context: true
        
        # HITL step
        - kind: hitl
          name: ask_user
          message: "{{ previous_step.question }}"
      
      # Exit when agent says finish
      exit_expression: "context.action == 'finish'"
      max_loops: 10

  # Final step to confirm we exited the loop
  - kind: step
    name: success
    uses: "flujo.builtins.passthrough"
    input: "SUCCESS! Loop exited cleanly after {{ context.count }} iterations."

